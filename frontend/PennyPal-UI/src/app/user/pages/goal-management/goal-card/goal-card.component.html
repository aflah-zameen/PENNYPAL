<div
  class="bg-white rounded-2xl shadow-lg hover:shadow-xl transition-all duration-300 p-6 border group relative overflow-hidden text-sm"
  [ngClass]="{
    'border-green-200 bg-gradient-to-br from-green-50 to-emerald-50': goal.status === 'COMPLETED',
    'border-yellow-200 bg-gradient-to-br from-yellow-50 to-amber-50': goal.status === 'WITHDRAW_PENDING',
    'border-blue-200 bg-gradient-to-br from-blue-50 to-sky-50': goal.status === 'WITHDRAW_COLLECTED',
    'border-red-200 bg-gradient-to-br from-red-50 to-rose-50': goal.status === 'WITHDRAW_REJECTED',
    'border-gray-100': goal.status !== 'COMPLETED' && goal.status !== 'WITHDRAW_PENDING' && goal.status !== 'WITHDRAW_COLLECTED' && goal.status !== 'WITHDRAW_REJECTED'
  }"
>
  <div *ngIf="goal.status === 'COMPLETED'" class="absolute inset-0 pointer-events-none">
    <div class="confetti" style="left: 10%; animation-delay: 0s; animation-duration: 6s;"></div>
    <div class="confetti" style="left: 20%; animation-delay: 1s; animation-duration: 5s;"></div>
    <div class="confetti" style="left: 50%; animation-delay: 0.5s; animation-duration: 7s;"></div>
    <div class="confetti" style="left: 70%; animation-delay: 2s; animation-duration: 4.5s;"></div>
    <div class="confetti" style="left: 90%; animation-delay: 3s; animation-duration: 5.5s;"></div>
  </div>

  <div
    class="absolute inset-0 opacity-0 group-hover:opacity-100 transition-opacity duration-300 rounded-2xl"
    [ngClass]="{
      'bg-gradient-to-r from-green-500/10 to-emerald-500/10': goal.status === 'COMPLETED',
      'bg-gradient-to-r from-red-500/10 to-rose-500/10': goal.status === 'WITHDRAW_REJECTED',
      'bg-gradient-to-r from-blue-500/5 to-purple-500/5': goal.status !== 'COMPLETED' && goal.status !== 'WITHDRAW_REJECTED'
    }"
  ></div>

  <div class="relative space-y-4">
    <div class="flex items-center space-x-4">
      <div
        class="h-12 w-12 flex-shrink-0 rounded-xl flex items-center justify-center text-white font-semibold text-2xl"
        [style.background-color]="goal.category.color"
        [ngClass]="{'ring-4 ring-green-200': goal.status === 'COMPLETED'}"
      >
        {{ goal.category.icon }}
      </div>
      <div>
        <h3
          class="font-bold text-xl leading-tight transition-colors"
          [ngClass]="{
            'text-green-800 group-hover:text-green-900': goal.status === 'COMPLETED',
            'text-yellow-800': goal.status === 'WITHDRAW_PENDING',
            'text-blue-800': goal.status === 'WITHDRAW_COLLECTED',
            'text-red-800': goal.status === 'WITHDRAW_REJECTED',
            'text-gray-900 group-hover:text-blue-700': goal.status !== 'COMPLETED' && goal.status !== 'WITHDRAW_PENDING' && goal.status !== 'WITHDRAW_COLLECTED' && goal.status !== 'WITHDRAW_REJECTED'
          }"
        >
          {{ goal.title }}
        </h3>
        <p class="text-gray-600 font-medium">
          Target: {{ formatCurrency(goal.targetAmount) }}
        </p>
      </div>
    </div>

    <div [ngSwitch]="goal.status">

      <ng-container *ngSwitchCase="'ACTIVE'">
        <div class="space-y-4">
          <div>
            <div class="flex justify-between items-center mb-1">
              <span class="text-sm font-medium text-gray-700">Progress</span>
              <span
                class="text-xs font-bold px-2 py-1 rounded-full shadow-sm"
                [style.background-color]="goal.category.color"
                [style.color]="getTextColorForBackground(goal.category.color)"
              >
                {{ progressPercentage }}%
              </span>
            </div>
            <div class="w-full h-2.5 bg-gray-200 rounded-full overflow-hidden">
              <div
                class="h-full rounded-full transition-all duration-500"
                [style.width.%]="progressPercentage"
                [style.background]="goal.category.color"
              ></div>
            </div>
          </div>
          <div class="grid grid-cols-2 gap-2 text-sm">
            <div class="p-2 rounded-lg bg-green-50/70 border border-green-100">
              <p class="text-xs text-gray-500">Saved</p>
              <p class="font-semibold text-gray-800">{{ formatCurrency(goal.currentAmount) }}</p>
            </div>
            <div class="p-2 rounded-lg bg-pink-50/70 border border-pink-100">
              <p class="text-xs text-gray-500">Ends On</p>
              <p class="font-semibold text-gray-800">{{ formatDate(goal.endDate) }}</p>
            </div>
          </div>
          <button (click)="openContributionModal()" class="w-full py-2.5 px-4 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition-all duration-200">
            Add Money
          </button>
        </div>
      </ng-container>

      <ng-container *ngSwitchCase="'COMPLETED'">
        <div class="text-center space-y-4 pt-4 pb-2">
          <div class="mx-auto w-16 h-16 bg-gradient-to-br from-green-500 to-emerald-500 rounded-full flex items-center justify-center shadow-lg">
            <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
          </div>
          <h4 class="text-green-800 font-bold text-xl">Goal Achieved!</h4>
          <p class="text-gray-600 text-sm max-w-xs mx-auto">
            Congratulations! You have saved {{ formatCurrency(goal.targetAmount) }}. You can now request to withdraw your funds.
          </p>
          <button (click)="requestWithdrawal()" class="w-full py-3 px-4 bg-gradient-to-r from-green-500 to-emerald-500 text-white font-semibold rounded-xl transition-all duration-200 hover:from-green-600 hover:to-emerald-600 hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-green-500">
            Request Withdraw
          </button>
        </div>
      </ng-container>

      <ng-container *ngSwitchCase="'WITHDRAW_PENDING'">
        <div class="text-center space-y-4 pt-4 pb-2">
          <div class="mx-auto w-16 h-16 bg-gradient-to-br from-yellow-400 to-amber-500 rounded-full flex items-center justify-center shadow-lg animate-pulse">
            <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
          </div>
          <h4 class="text-yellow-800 font-bold text-xl">Withdrawal Pending</h4>
          <p class="text-gray-600 text-sm max-w-xs mx-auto">
            Your request to withdraw {{ formatCurrency(goal.targetAmount) }} is being reviewed. This usually takes 1-2 business days.
          </p>
        </div>
      </ng-container>
      
      <ng-container *ngSwitchCase="'WITHDRAW_COLLECTED'">
        <div class="text-center space-y-4 pt-4 pb-2">
          <div class="mx-auto w-16 h-16 bg-gradient-to-br from-blue-500 to-sky-500 rounded-full flex items-center justify-center shadow-lg">
             <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
          </div>
          <h4 class="text-blue-800 font-bold text-xl">Amount Collected</h4>
          <p class="text-gray-600 text-sm max-w-xs mx-auto">
            You have successfully withdrawn {{ formatCurrency(goal.targetAmount) }} from this goal. Keep up the great work!
          </p>
        </div>
      </ng-container>

      <ng-container *ngSwitchCase="'WITHDRAW_REJECTED'">
        <div class="text-center space-y-4 pt-4 pb-2">
          <div class="mx-auto w-16 h-16 bg-gradient-to-br from-red-400 to-rose-500 rounded-full flex items-center justify-center shadow-lg">
            <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M6 18L18 6M6 6l12 12"></path></svg>
          </div>
          <h4 class="text-red-800 font-bold text-xl">Withdrawal Rejected</h4>
          <p class="text-gray-600 text-sm max-w-xs mx-auto">
            Unfortunately, your request to withdraw {{ formatCurrency(goal.targetAmount) }} could not be processed. Please check your details or contact support.
          </p>
          <button (click)="contactSupport()" class="w-full py-3 px-4 bg-gradient-to-r from-red-500 to-rose-500 text-white font-semibold rounded-xl transition-all duration-200 hover:from-red-600 hover:to-rose-600 hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-red-500">
            Contact Support
          </button>
        </div>
      </ng-container>

    </div>

    <div *ngIf="goal.status === 'ACTIVE'">
      <button (click)="toggleHistory()" class="text-sm font-semibold text-blue-600 hover:text-blue-800 transition-colors w-full text-left py-1">
        {{ isHistoryVisible ? 'Hide History' : 'View History' }} &rarr;
      </button>
      <app-contribution-history
        *ngIf="isHistoryVisible"
        [contributions]="goal.contributions || []"
        (deleteContribution)="onDeleteContribution($event)"
      ></app-contribution-history>
    </div>

  </div>

  <app-add-contribution
    *ngIf="isContributionModalOpen"
    [isModalOpen]="isContributionModalOpen"
    [goalId]="goal.id"
    [paymentMethods]="paymentMethods || []"
    [targetAmount]="goal.targetAmount"
    [currentAmount]="goal.currentAmount"
    [goalTitle]="goal.title"
    [goalColor]="goal.category.color"
    (close)="closeContributionModal()"
    (contributionSubmit)="onAddContribution($event)"
  ></app-add-contribution>
</div>